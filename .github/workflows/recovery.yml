name: Build-Patched-Recovery

on:
  workflow_dispatch:
    inputs:
      RECOVERY_URL:
        description: "Direct URL to recovery (.tar / .img / .lz4)"
        required: true                  # UI prompts every run
      PARTITION_SIZE:
        description: "Recovery partition size (SM-G977B = 64 MiB)"
        default:  "67108864"            # = 64 * 1024 * 1024

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------------------------------- code
    - uses: actions/checkout@v4

    # ------------------------------------------------ system deps & gdown --
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y curl wget lz4 tar file openssl binutils
        pipx install gdown

    # ------------------------------------------ magiskboot (real binary) --
    - name: Fetch magiskboot v26.4
      run: |
        curl -Lf --retry 3 -o magiskboot \
          https://github.com/topjohnwu/Magisk/releases/download/v26.4/magiskboot
        chmod +x magiskboot
        strip --strip-all magiskboot || true          # shrink ~1.6 MB → 0.7 MB

    # --------------------------- use repo avbtool, upgrade only if stale --
    - name: Prepare avbtool
      run: |
        chmod +x avbtool                      # ensure executable bit
        if ! grep -q cmd_set_hashtype avbtool ; then
          echo "→ Repo avbtool too old — downloading fresh copy"
          curl -Lf --retry 3 -o avbtool \
            https://raw.githubusercontent.com/LineageOS/android_external_avb/lineage-21.0/avbtool.py
          chmod +x avbtool
        fi
        echo "✓ avbtool ready"

    # ------------------------------------------- generate signing key -----
    - run: openssl genrsa -out avb.pem 4096

    # ------------------------------------------- fetch base recovery ------
    - name: Download recovery
      run: |
        set -euo pipefail
        mkdir _dl && cd _dl
        URL="${{ github.event.inputs.RECOVERY_URL }}"
        # Dropbox → direct binary
        [[ "$URL" == *dropbox.com* ]] && URL="${URL//www.dropbox.com/dl.dropboxusercontent.com}&dl=1"
        # Google Drive
        if [[ "$URL" == *drive.google.com* ]]; then
          gdown --fuzzy "$URL" -O in.bin
        else
          curl -Lf --retry 5 --retry-all-errors -o in.bin "$URL"
        fi
        # guard: refuse HTML / text
        file in.bin | grep -qE 'HTML|ASCII' && { echo "HTML received"; exit 86; }

    # ----------------------------- fastbootd patch & fstab cleanup --------
    - name: Patch fastbootd
      run: cd _dl && ../script1.sh        # script1 in repo root
    - name: Clean fstab
      run: cd _dl && ../script2.sh        # script2 in repo root

    # ------------------- flip hash-type to SHA-1 (Samsung needs this) -----
    - run: cd _dl && ../avbtool set_hashtype sha1 recovery.img

    # ---------------------- add SHA1_RSA4096 footer + size guard ----------
    - name: Add AVB footer
      run: |
        cd _dl
        SIZE="${{ github.event.inputs.PARTITION_SIZE }}"
        ../avbtool add_hash_footer \
          --partition_name recovery \
          --partition_size "$SIZE" \
          --image recovery.img \
          --key ../avb.pem \
          --algorithm SHA1_RSA4096
        [ $(stat -c%s recovery.img) -le "$SIZE" ] || { echo "Image too large"; exit 88; }

    # ----------------------------- package & checksums --------------------
    - name: Package Odin tar
      run: |
        OUT=$GITHUB_WORKSPACE/output && mkdir -p "$OUT"
        cp _dl/recovery.img "$OUT/"
        tar -C "$OUT" -cf "$OUT/fastbootd-recovery.tar" recovery.img
        md5sum -t "$OUT/fastbootd-recovery.tar" >> "$OUT/fastbootd-recovery.tar"
        mv "$OUT/fastbootd-recovery.tar" "$OUT/fastbootd-recovery.tar.md5"

    # ------------------------------- upload artefacts ---------------------
    - uses: actions/upload-artifact@v4
      with:
        name: Patched-Recovery
        path: output/*
